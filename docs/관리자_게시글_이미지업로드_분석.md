# 관리자 페이지 게시글 이미지/파일 업로드 기능 분석

> 작성일: 2025-12-23
> QA 요청: 본문 이미지 용량 제한 확인 및 에러 메시지 부재 문제

---

## 1. 개요

관리자 페이지의 게시글 작성/수정 시 3가지 유형의 파일 업로드 기능이 존재합니다:

| 유형 | 용량 제한 | 개수 제한 | 에러 메시지 |
|------|----------|----------|------------|
| 대표 이미지 (Thumbnail) | **없음** | 1장 | 없음 |
| 본문 이미지 (Body) | **없음** | **무제한** | **없음** |
| 첨부파일 (Attachment) | 20MB | 1개 | 있음 |

---

## 2. 각 업로드 유형별 상세 분석

### 2.1 대표 이미지 (Thumbnail)

**파일 위치**: `app/admin/posts/write/page.tsx` (lines 51-60)

```typescript
const handleThumbnailUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0]
  if (file) {
    const reader = new FileReader()
    reader.onloadend = () => {
      setThumbnailImage(reader.result as string)
    }
    reader.readAsDataURL(file)
  }
}
```

| 항목 | 현황 |
|------|------|
| 용량 제한 | **없음** |
| 개수 제한 | 1장 (상태변수로 덮어쓰기) |
| 파일 형식 제한 | HTML `accept="image/*"` 속성만 (서버측 검증 없음) |
| 에러 처리 | **없음** |
| 저장 형식 | Base64 인코딩 (`data:image/jpeg;base64,...`) |
| 저장 위치 | `Post.thumbnailImage` 필드 |

---

### 2.2 본문 이미지 (Body Images)

**파일 위치**: `app/admin/posts/write/page.tsx` (lines 82-101)

```typescript
const addImageToEditor = () => {
  const input = document.createElement("input")
  input.type = "file"
  input.accept = "image/*"
  input.onchange = (e) => {
    const file = (e.target as HTMLInputElement).files?.[0]
    if (file) {
      const reader = new FileReader()
      reader.onloadend = () => {
        const base64 = reader.result as string
        editor?.chain().focus().setImage({ src: base64 }).run()
      }
      reader.readAsDataURL(file)
    }
  }
  input.click()
}
```

| 항목 | 현황 |
|------|------|
| 용량 제한 | **없음** |
| 개수 제한 | **무제한** (에디터에 계속 삽입 가능) |
| 파일 형식 제한 | HTML `accept="image/*"` 속성만 |
| 에러 처리 | **없음** |
| 저장 형식 | HTML 내 Base64 `<img>` 태그 |
| 저장 위치 | `Post.content` HTML 문자열 내부 |

**Tiptap 에디터 설정**:
```typescript
Image.configure({
  inline: true,      // 인라인 이미지 허용
  allowBase64: true, // Base64 인코딩 허용
})
```

---

### 2.3 첨부파일 (Attachment)

**파일 위치**: `app/admin/posts/write/page.tsx` (lines 62-80)

```typescript
const handleAttachmentUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0]
  if (file) {
    const maxSize = 20 * 1024 * 1024 // 20MB
    if (file.size > maxSize) {
      alert("첨부파일은 최대 20MB까지 업로드 가능합니다.")
      return
    }
    const reader = new FileReader()
    reader.onloadend = () => {
      setAttachment({
        name: file.name,
        data: reader.result as string,
        size: file.size,
      })
    }
    reader.readAsDataURL(file)
  }
}
```

| 항목 | 현황 |
|------|------|
| 용량 제한 | **20MB** |
| 개수 제한 | 1개 (상태변수로 덮어쓰기) |
| 파일 형식 제한 | 없음 (모든 파일 허용) |
| 에러 처리 | **있음** - `alert()` 메시지 |
| 저장 형식 | Base64 인코딩 + 메타데이터 |
| 저장 위치 | `Post.attachment` 객체 |

---

## 3. 핵심 문제점: localStorage 용량 한계

### 3.1 문제 원인

모든 데이터가 **localStorage**에 저장되며, 브라우저별 용량 제한이 존재합니다:

| 브라우저 | localStorage 최대 용량 |
|----------|----------------------|
| Chrome | 약 5MB |
| Firefox | 약 5MB |
| Safari | 약 5MB |
| Edge | 약 5MB |

### 3.2 Base64 인코딩 오버헤드

Base64 인코딩은 원본 파일 대비 **약 33% 크기 증가**:

| 원본 크기 | Base64 크기 | 증가량 |
|----------|------------|--------|
| 1MB | ~1.33MB | +33% |
| 3MB | ~4MB | +33% |
| 5MB | ~6.67MB | +33% |

### 3.3 실제 저장 가능 용량 계산

```
localStorage 한계: 5MB
─────────────────────────────────
게시글 메타데이터: ~1KB
대표 이미지 1장 (1MB): ~1.33MB
본문 이미지 3장 (각 1MB): ~4MB
─────────────────────────────────
총합: 약 5.33MB → localStorage 초과!
```

**결론**: 본문 이미지 2-3장만 업로드해도 localStorage 한계에 도달할 수 있습니다.

### 3.4 에러 없이 저장 실패하는 이유

현재 코드에서 localStorage 저장 시 에러 처리가 없습니다:

```typescript
// 현재 코드 (write/page.tsx line 128)
localStorage.setItem("news_posts", JSON.stringify(posts))

// localStorage 용량 초과 시 자동으로 실패하며,
// try-catch가 없어 에러 메시지 표시 안 됨
```

---

## 4. 저장 구조

### 4.1 Post 타입 정의

**파일 위치**: `lib/posts.ts`

```typescript
export type Post = {
  id: number
  title: string
  content: string              // HTML (본문 이미지 포함)
  thumbnailImage?: string      // Base64
  category: "공지" | "행사" | "뉴스"
  status: boolean
  viewCount: number
  publishedAt: string
  createdAt: string
  updatedAt: string
  attachment?: {
    name: string
    data: string               // Base64
    size: number
  } | null
}
```

### 4.2 저장 흐름

```
[사용자] 이미지 선택
    ↓
[FileReader] readAsDataURL()
    ↓
[상태] Base64 문자열로 저장
    ↓
[저장 버튼 클릭]
    ↓
[JSON.stringify] 전체 posts 배열
    ↓
[localStorage.setItem] 저장 시도
    ↓
[용량 초과 시] QuotaExceededError (무시됨)
```

---

## 5. QA 요청에 대한 답변

### Q: 본문 이미지 용량 제한이 있는지?

**A: 코드상 명시적 제한은 없으나, localStorage 한계로 인한 암묵적 제한 존재**

| 항목 | 현황 |
|------|------|
| 코드상 이미지 1장 용량 제한 | 없음 |
| 코드상 이미지 개수 제한 | 없음 |
| 실제 저장 가능 총 용량 | ~3-4MB (localStorage 5MB - 메타데이터) |
| 실제 저장 가능 이미지 수 | 1MB 이미지 기준 약 2-3장 |

### Q: 에러 메시지 없이 등록이 안 되는 원인

**A: localStorage `QuotaExceededError` 미처리**

```javascript
// 브라우저 콘솔에서 다음 에러 발생 (사용자에게는 표시 안 됨):
// Uncaught QuotaExceededError: Failed to execute 'setItem' on 'Storage':
// The quota has been exceeded.
```

---

## 6. 권장 개선사항

### 6.1 즉시 적용 가능 (현재 구조 유지)

#### A. 본문 이미지 용량/개수 제한 추가

```typescript
// 권장 제한값
const MAX_BODY_IMAGE_SIZE = 500 * 1024  // 500KB per image
const MAX_BODY_IMAGE_COUNT = 5           // 최대 5장
```

#### B. localStorage 저장 에러 처리 추가

```typescript
try {
  localStorage.setItem("news_posts", JSON.stringify(posts))
  alert("저장되었습니다.")
} catch (e) {
  if (e instanceof DOMException && e.name === 'QuotaExceededError') {
    alert("저장 공간이 부족합니다. 이미지 크기를 줄이거나 개수를 줄여주세요.")
  }
}
```

#### C. 이미지 압축 적용

```typescript
// 업로드 전 이미지 리사이즈/압축
const compressImage = async (file: File, maxWidth = 800): Promise<string> => {
  // canvas를 이용한 이미지 압축 로직
}
```

### 6.2 장기적 개선 (구조 변경 필요)

| 방안 | 설명 |
|------|------|
| 서버 업로드 | 이미지를 서버에 저장, URL만 localStorage에 저장 |
| IndexedDB | localStorage 대신 IndexedDB 사용 (수백 MB 가능) |
| 외부 스토리지 | Cloudinary, AWS S3 등 이미지 호스팅 서비스 연동 |

---

## 7. 파일 경로 참조

| 파일 | 경로 |
|------|------|
| 게시글 작성 | `app/admin/posts/write/page.tsx` |
| 게시글 수정 | `app/admin/posts/[id]/page.tsx` |
| Post 타입 정의 | `lib/posts.ts` |
| 게시글 목록 | `app/admin/posts/page.tsx` |

---

## 8. 요약

| 구분 | 대표 이미지 | 본문 이미지 | 첨부파일 |
|------|-----------|-----------|---------|
| 용량 제한 | 없음 | 없음 | 20MB |
| 개수 제한 | 1장 | 무제한 | 1개 |
| 에러 메시지 | 없음 | 없음 | 있음 |
| 실제 문제 | localStorage 한계 | localStorage 한계 | Base64 크기 증가 |

**핵심 이슈**: 본문 이미지에 대한 용량/개수 제한이 없고, localStorage 저장 실패 시 에러 메시지가 표시되지 않아 사용자가 저장 실패 원인을 알 수 없음.
