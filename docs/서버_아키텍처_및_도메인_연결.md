# 서버 아키텍처 및 도메인 연결 문서

## 개요

이 문서는 이대목동병원 장애인 이용편의 지원센터 웹사이트의 서버 구성, Nginx 리버스 프록시 설정, 그리고 Cloudflare Tunnel을 통한 외부 도메인 연결 구조를 설명합니다.

## 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              인터넷 (사용자)                                  │
│                        https://remo-test.online                             │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Cloudflare Network                                 │
│                    (SSL 인증서 자동 관리, DDoS 보호)                          │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Cloudflare Tunnel (cloudflared)                          │
│                       터널 ID: remo-tunnel                                   │
│                   49a156c2-21fd-4962-a01c-b09892255da6                      │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         로컬 서버 (finefittemp-desktop)                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Nginx (포트 3111)                                 │   │
│  │              리버스 프록시 → localhost:3112                          │   │
│  └─────────────────────────────────┬───────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                  Next.js 애플리케이션 (포트 3112)                    │   │
│  │                     npm run dev / npm run start                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 왜 이 구성을 사용하는가?

### 문제점
- 서버에서 **80번 포트 사용 불가** (권한 또는 다른 서비스와 충돌)
- 외부에서 직접 로컬 서버 접근 불가 (방화벽, NAT 환경)
- SSL 인증서 관리 부담

### 해결책: Cloudflare Tunnel
- **80/443 포트 불필요**: Cloudflare가 외부 트래픽을 처리
- **SSL 자동 관리**: Cloudflare에서 HTTPS 인증서 자동 발급
- **보안 강화**: 서버 IP 노출 없이 서비스 제공
- **방화벽 우회**: 아웃바운드 연결만 사용하므로 인바운드 포트 개방 불필요

---

## 1. Next.js 애플리케이션 설정

### 위치
```
/home/finefit-temp/Desktop/project/ehwa_website/
```

### package.json 스크립트
```json
{
  "scripts": {
    "dev": "next dev --port 3112 --hostname 0.0.0.0",
    "build": "next build",
    "start": "next start --port 3112 --hostname 0.0.0.0"
  }
}
```

### next.config.mjs
```javascript
const nextConfig = {
  typescript: {
    ignoreBuildErrors: true,
  },
  images: {
    unoptimized: true,
  },
  // 외부 접근 허용을 위한 CORS 설정
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          { key: 'Access-Control-Allow-Origin', value: '*' },
          { key: 'Access-Control-Allow-Methods', value: 'GET, POST, PUT, DELETE, OPTIONS' },
          { key: 'Access-Control-Allow-Headers', value: 'Content-Type, Authorization' },
        ],
      },
    ]
  },
}
```

### 주요 포인트
- **포트 3112**: Next.js 개발/프로덕션 서버 실행 포트
- **hostname 0.0.0.0**: 외부 네트워크에서 접근 허용
- **CORS 헤더**: 모든 출처에서 API 요청 허용

---

## 2. Nginx 리버스 프록시 설정

### 설정 파일 위치
```
/etc/nginx/sites-available/remo-test.online
```

### 설정 내용
```nginx
server {
    listen 3111;
    server_name remo-test.online www.remo-test.online;

    location / {
        proxy_pass http://localhost:3112;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 심볼릭 링크
```bash
# 사이트 활성화
/etc/nginx/sites-enabled/remo-test.online -> /etc/nginx/sites-available/remo-test.online
```

### Nginx 역할
| 헤더 | 설명 |
|------|------|
| `proxy_pass` | 요청을 Next.js 서버(3112)로 전달 |
| `X-Real-IP` | 클라이언트 실제 IP 전달 |
| `X-Forwarded-For` | 프록시 체인 정보 전달 |
| `X-Forwarded-Proto` | 원본 프로토콜(http/https) 전달 |
| `Upgrade/Connection` | WebSocket 연결 지원 |

### 관리 명령어
```bash
# Nginx 상태 확인
sudo systemctl status nginx

# 설정 테스트
sudo nginx -t

# Nginx 재시작
sudo systemctl restart nginx

# Nginx 재로드 (무중단)
sudo systemctl reload nginx
```

---

## 3. Cloudflare Tunnel (cloudflared) 설정

### 터널 정보
| 항목 | 값 |
|------|-----|
| 터널 이름 | remo-tunnel |
| 터널 ID | 49a156c2-21fd-4962-a01c-b09892255da6 |
| 사용자 | finefit-temp |

### 설정 파일 위치
```
/etc/cloudflared/config.yml
```

### 설정 내용
```yaml
tunnel: remo-tunnel
credentials-file: /home/finefit-temp/.cloudflared/49a156c2-21fd-4962-a01c-b09892255da6.json

ingress:
  - hostname: remo-test.online
    service: http://localhost:3111
  - service: http_status:404
```

### 설정 설명
- `tunnel`: 터널 이름 또는 ID
- `credentials-file`: 터널 인증을 위한 자격 증명 파일
- `ingress`: 도메인별 라우팅 규칙
  - `remo-test.online` → `localhost:3111` (Nginx)
  - 매칭되지 않는 요청 → 404 응답

### Systemd 서비스 파일
```
/etc/systemd/system/cloudflared.service
```

```ini
[Unit]
Description=cloudflared
After=network-online.target
Wants=network-online.target

[Service]
TimeoutStartSec=15
Type=notify
ExecStart=/usr/bin/cloudflared --no-autoupdate --config /etc/cloudflared/config.yml tunnel run
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
```

### 관리 명령어
```bash
# 상태 확인
sudo systemctl status cloudflared

# 시작
sudo systemctl start cloudflared

# 중지
sudo systemctl stop cloudflared

# 재시작
sudo systemctl restart cloudflared

# 부팅 시 자동 시작 활성화
sudo systemctl enable cloudflared

# 로그 확인
sudo journalctl -u cloudflared -f
```

---

## 4. 트래픽 흐름 상세

```
1. 사용자가 https://remo-test.online 접속
        │
        ▼
2. Cloudflare DNS가 요청을 Cloudflare Edge 서버로 라우팅
        │
        ▼
3. Cloudflare가 SSL/TLS 종료 처리 (HTTPS → HTTP)
        │
        ▼
4. Cloudflare Tunnel을 통해 로컬 cloudflared 데몬으로 전송
        │
        ▼
5. cloudflared가 localhost:3111 (Nginx)로 요청 전달
        │
        ▼
6. Nginx가 localhost:3112 (Next.js)로 프록시
        │
        ▼
7. Next.js가 요청 처리 후 응답 반환
        │
        ▼
8. 응답이 역순으로 사용자에게 전달
```

---

## 5. 포트 사용 현황

| 포트 | 서비스 | 용도 |
|------|--------|------|
| 3111 | Nginx | Cloudflared 인그레스 포인트, 리버스 프록시 |
| 3112 | Next.js | 웹 애플리케이션 서버 |
| 20241 | cloudflared | 메트릭 서버 (127.0.0.1 전용) |

---

## 6. 서비스 시작 순서

서버 부팅 또는 재시작 시 다음 순서로 서비스를 시작해야 합니다:

```bash
# 1. Next.js 애플리케이션 시작
cd /home/finefit-temp/Desktop/project/ehwa_website
npm run start &
# 또는 개발 모드: npm run dev &

# 2. Nginx 시작 (이미 systemd로 자동 시작됨)
sudo systemctl start nginx

# 3. Cloudflared 시작 (이미 systemd로 자동 시작됨)
sudo systemctl start cloudflared
```

> **참고**: Nginx와 cloudflared는 systemd에 등록되어 있어 서버 부팅 시 자동 시작됩니다. Next.js 앱은 별도로 시작해야 합니다. PM2 같은 프로세스 매니저 사용을 권장합니다.

---

## 7. 문제 해결

### Next.js 서버가 시작되지 않는 경우
```bash
# 프로세스 확인
lsof -i :3112

# 로그 확인
cd /home/finefit-temp/Desktop/project/ehwa_website
npm run dev
```

### Nginx 502 Bad Gateway 오류
```bash
# Next.js 서버 실행 중인지 확인
curl http://localhost:3112

# Nginx 설정 확인
sudo nginx -t

# Nginx 에러 로그 확인
sudo tail -f /var/log/nginx/error.log
```

### Cloudflared 연결 문제
```bash
# 서비스 상태 확인
sudo systemctl status cloudflared

# 터널 상태 확인
cloudflared tunnel info remo-tunnel

# 로그 확인
sudo journalctl -u cloudflared -f
```

### 도메인 접속 불가
1. Cloudflare 대시보드에서 DNS 설정 확인
2. 터널이 활성 상태인지 확인
3. 로컬 서비스(Nginx, Next.js) 실행 상태 확인

---

## 8. 보안 고려사항

1. **서버 IP 비노출**: Cloudflare Tunnel을 통해 실제 서버 IP가 외부에 노출되지 않음
2. **SSL/TLS 자동 관리**: Cloudflare에서 인증서 자동 발급 및 갱신
3. **DDoS 보호**: Cloudflare 네트워크에서 기본적인 DDoS 공격 차단
4. **인바운드 포트 미개방**: 80, 443 포트 개방 없이 서비스 가능

---

## 9. 관련 파일 경로 요약

| 파일 | 경로 |
|------|------|
| Next.js 프로젝트 | `/home/finefit-temp/Desktop/project/ehwa_website/` |
| Next.js 설정 | `next.config.mjs` |
| package.json | `package.json` |
| Nginx 사이트 설정 | `/etc/nginx/sites-available/remo-test.online` |
| Nginx 활성화 링크 | `/etc/nginx/sites-enabled/remo-test.online` |
| Cloudflared 설정 | `/etc/cloudflared/config.yml` |
| Cloudflared 자격증명 | `/home/finefit-temp/.cloudflared/49a156c2-21fd-4962-a01c-b09892255da6.json` |
| Cloudflared 서비스 | `/etc/systemd/system/cloudflared.service` |

---

**최종 업데이트**: 2025년 12월 23일
